/****** Script for SELECTTopNRows command FROM SSMS  ******/
--/****** Creating the company structure tables/****** 

/*
Filter for company

SELECT * 
FROM [MSS].[dbo].[GL40200] 
WHERE SGMTNUMB = 2
ORDER BY SGMNTID

SELECT * FROM [DWH_Code].[dbo].[company_structure_active_inactive] ORDER BY Company 
*/

/*
--Finding location

SELECT SGMNTID, DSCRIPTN  
FROM [MSS].[dbo].[GL40200] 
WHERE SGMTNUMB = 2
ORDER BY SGMNTID
*/

-- Create [DWH_Code].[dbo].[#company]
-- SELECT * FROM [DWH_Code].[dbo].[#company] ORDER BY SGMNTID
-- Drop Table [DWH_Code].[dbo].[#company]


DECLARE @COMPANY AS TABLE
			(
			[SGMNTID] INT,
			[DSCRIPTN] VARCHAR(100)
			)

INSERT INTO @COMPANY 
SELECT [SGMNTID] , [DSCRIPTN]  
FROM [MSS].[dbo].[GL40200] 
WHERE SGMTNUMB = 4 AND SGMNTID <>0
ORDER BY SGMNTID



SELECT * FROM @COMPANY ORDER BY SGMNTID

-- Finding the new company and changing the mapping for triggerid

SELECT [SGMNTID] , [DSCRIPTN]
FROM   @COMPANY
WHERE  [SGMNTID] NOT IN (SELECT [Company] FROM [DWH_Code].[dbo].[company_structure_active_inactive])


--Create variable table (Work Paper AS WP)

DECLARE @WP AS TABLE
			(
			[L0] VARCHAR(5),
			[Location] INT,
			[Company] INT,
			[Description] VARCHAR(100),
			[Database] VARCHAR(3),
			[Trigger ID] INT,
			[Active/Inactive] VARCHAR(100)
			)

INSERT INTO @WP
SELECT 
CASE 
	WHEN (MSS.DBO.GL40200.SGMNTID = 0105) THEN ''
	WHEN (MSS.DBO.GL40200.SGMNTID > 4999) THEN ''
	WHEN (MSS.DBO.GL40200.SGMNTID = 3001) THEN 'M001'
	WHEN (MSS.DBO.GL40200.SGMNTID = 3002) THEN 'L044'
	WHEN (MSS.DBO.GL40200.SGMNTID = 3003) THEN 'L045'
	WHEN (MSS.DBO.GL40200.SGMNTID = 3004) THEN 'L045A'
	ELSE 'L'+RIGHT(left(MSS.DBO.GL40200.SGMNTID, 4),3) 
END AS [L0], 
CASE 
	WHEN (MSS.DBO.GL40200.SGMNTID >4999) THEN MSS.DBO.GL40200.SGMNTID
	WHEN (MSS.DBO.GL40200.SGMNTID BETWEEN 3001 AND 3004 ) THEN MSS.DBO.GL40200.SGMNTID
	WHEN (MSS.DBO.GL40200.SGMNTID BETWEEN 3063 AND 3068) THEN MSS.DBO.GL40200.SGMNTID
	ELSE '1'+RIGHT(left(MSS.DBO.GL40200.SGMNTID, 4),3)
END AS [Location],
[SGMNTID] [Company],
TRIM([DSCRIPTN]) [Description],
CASE 
	WHEN (MSS.DBO.GL40200.SGMNTID between 0 AND 4999) THEN 'SS'
	WHEN (MSS.DBO.GL40200.SGMNTID = 7255) THEN 'MSS'
	WHEN (MSS.DBO.GL40200.SGMNTID = 7257) THEN 'MSS'
	WHEN (MSS.DBO.GL40200.SGMNTID = 7602) THEN 'MSS'
	WHEN (MSS.DBO.GL40200.SGMNTID between 7100 AND 9999) THEN 'SS'
	WHEN (MSS.DBO.GL40200.SGMNTID = 7041) THEN 'SS'
	ELSE 'MSS'
END AS [Database],
CASE 
--Holdings Fund 1
	WHEN (MSS.DBO.GL40200.SGMNTID between 1001 and 1005) THEN'7100'
	WHEN (MSS.DBO.GL40200.SGMNTID between 1007 and 1008) THEN'7100'
--Holdings Fund 2
	WHEN (MSS.DBO.GL40200.SGMNTID = '1006') THEN'7101'
	WHEN (MSS.DBO.GL40200.SGMNTID between 1009 and 1011) THEN'7101'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1013') THEN'7101'
	WHEN (MSS.DBO.GL40200.SGMNTID between 1016 and 1017) THEN'7101'
--Holdings Fund 4
	WHEN (MSS.DBO.GL40200.SGMNTID between 1028 and 1029) THEN'7103'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1031') THEN'7103'
--Holdings Fund 6
	WHEN (MSS.DBO.GL40200.SGMNTID = '1021') THEN'7105'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1040') THEN'7105'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1050') THEN'7105'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1054') THEN'7105'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1062') THEN'7105'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1069') THEN'7105'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1076') THEN'7105'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1079') THEN'7105'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1081') THEN'7105'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1103') THEN'7105'
--TGA SS SC Portfolio Venture
	WHEN (MSS.DBO.GL40200.SGMNTID between 2000 and 3000) THEN'7107'
--Storage Depot Carmel JV
	WHEN (MSS.DBO.GL40200.SGMNTID = '1060') THEN'7111'
--Keystone
	WHEN (MSS.DBO.GL40200.SGMNTID between 1019 and 1020) THEN'7201'
	WHEN (MSS.DBO.GL40200.SGMNTID between 1022 and 1024) THEN'7201'
--Keystone 2
	WHEN (MSS.DBO.GL40200.SGMNTID = '1033') THEN'7202'
	WHEN (MSS.DBO.GL40200.SGMNTID between 1035 and 1036) THEN'7202'
--Keystone 3
	WHEN (MSS.DBO.GL40200.SGMNTID = '1037') THEN'7203'
	WHEN (MSS.DBO.GL40200.SGMNTID between 1041 and 1043) THEN'7203'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1053') THEN'7203'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1055') THEN'7203'
	WHEN (MSS.DBO.GL40200.SGMNTID between 1057 and 1059) THEN'7203'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1068') THEN'7203'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1071') THEN'7203'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1080') THEN'7203'
--Keystone 4
	WHEN (MSS.DBO.GL40200.SGMNTID = '1051') THEN'7207'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1100') THEN'7207'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1105') THEN'7207'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1107') THEN'7207'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1108') THEN'7207'
--191 IV Store Space
	WHEN (MSS.DBO.GL40200.SGMNTID between 1025 and 1027) THEN'7250'
--191 IV Store Space TN
	WHEN (MSS.DBO.GL40200.SGMNTID = '1030') THEN'7253'
--TGA SS Self Storage Tranche 1
	WHEN (MSS.DBO.GL40200.SGMNTID between 1047 and 1049) THEN'7274'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1061') THEN'7274'
	WHEN (MSS.DBO.GL40200.SGMNTID between 1066 and 1067) THEN'7274'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1073') THEN'7274'
--SAF SS Tranche 1 JV
	WHEN (MSS.DBO.GL40200.SGMNTID = '1070') THEN'7275'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1072') THEN'7275'
--Dev Fund 1
	WHEN (MSS.DBO.GL40200.SGMNTID = '1018') THEN'7401'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1104') THEN'7401'
--Dev Fund 2
	WHEN (MSS.DBO.GL40200.SGMNTID = '1087') THEN'7402'
--Dev Fund 3
	WHEN (MSS.DBO.GL40200.SGMNTID = '1082') THEN'7403'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1114') THEN'7403'
--Dev Fund 5
	WHEN (MSS.DBO.GL40200.SGMNTID = '1113') THEN'7405'
--QR Core 1
	WHEN (MSS.DBO.GL40200.SGMNTID between 4000 and 4999) THEN'7500'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1124') THEN'7500'
--QR Value 1
	WHEN (MSS.DBO.GL40200.SGMNTID = '1099') THEN'7530'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1106') THEN'7530'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1083') THEN'7530'
--Peoples Choice Storage
	WHEN (MSS.DBO.GL40200.SGMNTID between 3093 and 3095) THEN'7115'
--2022 Hldgs Fund 1
	WHEN (MSS.DBO.GL40200.SGMNTID = '1086') THEN'7601'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1089') THEN'7601'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1092') THEN'7601'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1120') THEN'7601'
	WHEN (MSS.DBO.GL40200.SGMNTID = '1125') THEN'7601'
--Jacksonville JV
	WHEN (MSS.DBO.GL40200.SGMNTID = '1098') THEN'7113'
--Bravo NB JV
	WHEN (MSS.DBO.GL40200.SGMNTID = '1075') THEN'7112'
--Bravo FR JV
	WHEN (MSS.DBO.GL40200.SGMNTID = '1088') THEN'7116'
--SC CDK JV
	WHEN (MSS.DBO.GL40200.SGMNTID = '1056') THEN'7108'
--CDK Taylor JV
	WHEN (MSS.DBO.GL40200.SGMNTID = '1074') THEN'7117'
--CDK Gratiot JV
	WHEN (MSS.DBO.GL40200.SGMNTID = '1090') THEN'7120'
--CDK Ft Myers JV
	WHEN (MSS.DBO.GL40200.SGMNTID = '1109') THEN'7119'
--CDK Warren JV
	WHEN (MSS.DBO.GL40200.SGMNTID = '1111') THEN'7118'

--Management, LP
--History for old companies that shouldn't have triggers
	WHEN (MSS.DBO.GL40200.SGMNTID between 0 and 1000) THEN''
	ELSE '7011'
END AS [Trigger ID],
CASE 
	WHEN (MSS.DBO.GL40200.SGMNTID between 0025 and 1013) THEN 'No'
	WHEN (MSS.DBO.GL40200.SGMNTID between 1014 and 1017) THEN 'No'
	WHEN (MSS.DBO.GL40200.SGMNTID between 1019 and 1020) THEN 'No'
	WHEN (MSS.DBO.GL40200.SGMNTID between 1022 and 1024) THEN 'No'
	WHEN (MSS.DBO.GL40200.SGMNTID between 1028 and 1029) THEN 'No'
	WHEN (MSS.DBO.GL40200.SGMNTID between 1031 and 1032) THEN 'No'
	WHEN (MSS.DBO.GL40200.SGMNTID between 1034 and 1036) THEN 'No'
	WHEN (MSS.DBO.GL40200.SGMNTID = 1101) THEN 'No'
	WHEN (MSS.DBO.GL40200.SGMNTID = 1104) THEN 'No'
	WHEN (MSS.DBO.GL40200.SGMNTID = 3051) THEN 'No'
	WHEN (MSS.DBO.GL40200.SGMNTID between 3002 and 3004) THEN 'No'
	WHEN (MSS.DBO.GL40200.SGMNTID = 3040) THEN 'No'
	WHEN (MSS.DBO.GL40200.SGMNTID between 3063 and 3065) THEN 'No'
	WHEN (MSS.DBO.GL40200.SGMNTID between 3068 and 3073) THEN 'No'
	WHEN (MSS.DBO.GL40200.SGMNTID = 3083) THEN 'No'
	WHEN (MSS.DBO.GL40200.SGMNTID between 3093 and 3102) THEN 'No'
	WHEN (MSS.DBO.GL40200.SGMNTID = 7005) THEN 'No'
	WHEN (MSS.DBO.GL40200.SGMNTID = 7016) THEN 'No'
	WHEN (MSS.DBO.GL40200.SGMNTID = 7204) THEN 'No'
	ELSE 'Yes' 
END AS [Active/Inactive]
FROM [MSS].[dbo].[GL40200]
WHERE SGMTNUMB = 4
ORDER BY [Company]


--SELECT * FROM @WP ORDER BY [Company]



--Create variable table (Work Paper AS WP2) 

DECLARE @WP2 AS TABLE
			(
			[L0] VARCHAR(5),
			[Location] INT,
			[Company] INT,
			[Description] VARCHAR(100),
			[Database] VARCHAR(3),
			[Trigger ID] INT,
			[Trigger Company Name] VARCHAR(100),
			[Upper Level Segment ID] INT,
			[Active/Inactive] VARCHAR(100)
			)


INSERT INTO @WP2
SELECT W.[L0]
      ,W.[Location]
	  ,W.[Company]
      ,W.[Description]
      ,W.[Database]
	  ,W.[Trigger ID]
      ,TRIM(U.[DSCRIPTN]) AS [Trigger Company Name]
      ,CASE 
		WHEN (W.[Company] = '1052') THEN '7000'
		WHEN (W.[Company] = '1075') THEN '7112'
		WHEN (W.[Company] = '1088') THEN '7116'
		WHEN (W.[Company] = '1098') THEN '7113'
		WHEN (W.[Company] > 4999) THEN [Company]
		ELSE W.[Trigger ID]
	  END AS [Upper Level Segment ID]
      ,W.[Active/Inactive]


FROM @WP W
LEFT JOIN @COMPANY U
ON W.[Trigger ID] = U.[SGMNTID]
ORDER BY Company

--SELECT * FROM @WP2 ORDER BY Company

DECLARE @WP3 AS TABLE
			(
			[L0] VARCHAR(5),
			[Location] INT,
			[Company] INT,
			[Description] VARCHAR(100),
			[Database] VARCHAR(3),
			[Trigger ID] INT,
			[Trigger Company Name] VARCHAR(100),
			[Upper Level Segment ID] INT,
			[Upper Level Company Name] VARCHAR(100),
			[Active/Inactive] VARCHAR(100)
			)


INSERT INTO @WP3
SELECT W.[L0]
      ,W.[Location]
	  ,W.[Company]
      ,W.[Description]
      ,W.[Database]
	  ,W.[Trigger ID]
      ,TRIM(U.[DSCRIPTN]) AS [Trigger Company Name]
      ,CASE 
		WHEN (W.[Company] = '1052') THEN '7000'
		WHEN (W.[Company] = '1075') THEN '7112'
		WHEN (W.[Company] = '1088') THEN '7116'
		WHEN (W.[Company] = '1098') THEN '7113'
		WHEN (W.[Company] > 4999) THEN [Company]
		ELSE W.[Trigger ID]
	  END AS [Upper Level Segment ID]
	  ,TRIM(U.[DSCRIPTN]) AS [Upper Level Company Name]
      ,W.[Active/Inactive]


FROM @WP2 W
LEFT JOIN @COMPANY U
ON W.[Trigger ID] = U.[SGMNTID]
ORDER BY Company

-- Adding table [company_structure_active_inactive]

Drop Table [DWH_Code].[dbo].[company_structure_active_inactive]

SELECT W.[L0]
      ,W.[Location]
	  ,W.[Company]
      ,Trim(W.[Description]) AS [Description]
      ,W.[Database]
	  ,W.[Trigger ID]
      ,W.[Trigger Company Name]
      ,W.[Upper Level Segment ID]
	  ,TRIM(U.[DSCRIPTN]) AS [Upper Level Company Name]
      ,W.[Active/Inactive]

INTO [DWH_Code].[dbo].[company_structure_active_inactive]
FROM @WP2 W
left outer join @COMPANY U
On W.[Upper Level Segment ID] = U.[SGMNTID]
WHERE COMPANY <> 0
ORDER BY Company

SELECT * FROM [DWH_Code].[dbo].[company_structure_active_inactive] ORDER BY Company 

--Remove Inactive Properties
Drop Table [DWH_Code].[dbo].[company_structure_active]
SELECT * 
INTO [DWH_Code].[dbo].[company_structure_active]
FROM [DWH_Code].[dbo].[company_structure_active_inactive]
WHERE [Active/Inactive] ='Yes'
ORDER BY [Company]
ALTER TABLE [DWH_Code].[dbo].[company_structure_active]
DROP COLUMN [Active/Inactive];

SELECT * FROM [DWH_Code].[dbo].[company_structure_active] ORDER BY [Company]
SELECT * FROM [DWH_Code].[dbo].[company_structure_active] ORDER BY [L0]